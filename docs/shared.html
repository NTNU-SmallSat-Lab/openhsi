---

title: Shared `multiprocessing.Array`s for Continuous Camera Collect (Parallel DataCube Saving)


keywords: fastai
sidebar: home_sidebar

summary: "We want to collect datacubes nonstop. Saving is a blocking operation which leaves gaps in the data we save on the order of a few seconds. The larger the datacube, the longer this gap. We really don’t want these gaps, yet we want to save raw data. Saving raw data is extremely demanding (15 s of collect requires 15 s to save). Can the saving be done in parallel? The following tries to address this issue."
description: "We want to collect datacubes nonstop. Saving is a blocking operation which leaves gaps in the data we save on the order of a few seconds. The larger the datacube, the longer this gap. We really don’t want these gaps, yet we want to save raw data. Saving raw data is extremely demanding (15 s of collect requires 15 s to save). Can the saving be done in parallel? The following tries to address this issue."
nb_path: "nbs/11_shared.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/11_shared.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>{% include tip.html content='This module can be imported using <code>from openhsi.shared import *</code>' %}{% include warning.html content='Experimental' %}</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="SharedCircArrayBuffer" class="doc_header"><code>class</code> <code>SharedCircArrayBuffer</code><a href="https://github.com/openhsi/openhsi/tree/master/openhsi/shared.py#L28" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>SharedCircArrayBuffer</code>(<strong><code>size</code></strong>:<code>tuple</code>=<em><code>(100, 100)</code></em>, <strong><code>axis</code></strong>:<code>int</code>=<em><code>0</code></em>, <strong><code>c_dtype</code></strong>:<code>type</code>=<em><code>c_int</code></em>, <strong><code>show_func</code></strong>:<code>Callable</code>[<code>ndarray</code>, <code>ForwardRef('plot')</code>]=<em><code>None</code></em>) :: <a href="/openhsi/data.html#CircArrayBuffer"><code>CircArrayBuffer</code></a></p>
</blockquote>

<pre><code>Circular FIFO Buffer implementation on multiprocessing.Array. Each put/get is a (n-1)darray.</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="SharedDataCube" class="doc_header"><code>class</code> <code>SharedDataCube</code><a href="https://github.com/openhsi/openhsi/tree/master/openhsi/shared.py#L46" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>SharedDataCube</code>(<strong><code>n_lines</code></strong>:<code>int</code>=<em><code>16</code></em>, <strong><code>processing_lvl</code></strong>:<code>int</code>=<em><code>-1</code></em>, <strong><code>json_path</code></strong>:<code>str</code>=<em><code>None</code></em>, <strong><code>pkl_path</code></strong>:<code>str</code>=<em><code>None</code></em>, <strong><code>print_settings</code></strong>=<em><code>False</code></em>) :: <a href="/openhsi/data.html#CameraProperties"><code>CameraProperties</code></a></p>
</blockquote>

<pre><code>Facilitates the collection, viewing, and saving of hyperspectral datacubes using
two `SharedCircArrayBuffer`s that swap when save is called.</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="SharedDataCube.save" class="doc_header"><code>SharedDataCube.save</code><a href="https://github.com/openhsi/openhsi/tree/master/openhsi/shared.py#L78" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>SharedDataCube.save</code>(<strong><code>save_dir</code></strong>:<code>str</code>, <strong><code>preconfig_meta_path</code></strong>:<code>str</code>=<em><code>None</code></em>, <strong><code>prefix</code></strong>:<code>str</code>=<em><code>''</code></em>, <strong><code>suffix</code></strong>:<code>str</code>=<em><code>''</code></em>)</p>
</blockquote>

<pre><code>Saves to a NetCDF file (and RGB representation) to directory dir_path in folder given by date with file name given by UTC time.
Save is done in a separate multiprocess.Process.</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="save_shared_datacube" class="doc_header"><code>save_shared_datacube</code><a href="https://github.com/openhsi/openhsi/tree/master/openhsi/shared.py#L121" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>save_shared_datacube</code>(<strong><code>fname</code></strong>:<code>str</code>, <strong><code>shared_array</code></strong>:<a href="/openhsi/capture.html#Array"><code>Array</code></a>, <strong><code>c_dtype</code></strong>:<code>type</code>, <strong><code>shape</code></strong>:<code>Tuple</code>, <strong><code>coords_dict</code></strong>:<code>Dict</code>[<code>~KT</code>, <code>~VT</code>], <strong><code>attrs_dict</code></strong>:<code>Dict</code>[<code>~KT</code>, <code>~VT</code>], <strong><code>proc_lvl</code></strong>:<code>int</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="OpenHSI-using-shared-multiprocessing.Array-in-SharedDataCube">OpenHSI using shared multiprocessing.Array in SharedDataCube<a class="anchor-link" href="#OpenHSI-using-shared-multiprocessing.Array-in-SharedDataCube"> </a></h2><p><a href="/openhsi/shared.html#SharedOpenHSI"><code>SharedOpenHSI</code></a> has the same API as <a href="/openhsi/capture.html#OpenHSI"><code>OpenHSI</code></a> with the addition of a camera temperature buffer that automatically swaps over when a save is called.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="SharedOpenHSI" class="doc_header"><code>class</code> <code>SharedOpenHSI</code><a href="https://github.com/openhsi/openhsi/tree/master/openhsi/shared.py#L166" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>SharedOpenHSI</code>(<strong><code>n_lines</code></strong>:<code>int</code>=<em><code>16</code></em>, <strong><code>processing_lvl</code></strong>:<code>int</code>=<em><code>-1</code></em>, <strong><code>json_path</code></strong>:<code>str</code>=<em><code>None</code></em>, <strong><code>pkl_path</code></strong>:<code>str</code>=<em><code>None</code></em>, <strong><code>print_settings</code></strong>=<em><code>False</code></em>) :: <a href="/openhsi/shared.html#SharedDataCube"><code>SharedDataCube</code></a></p>
</blockquote>

<pre><code>Base Class for the OpenHSI Camera.</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>See <a href="https://openhsi.github.io/openhsi/capture.html">https://openhsi.github.io/openhsi/capture.html</a> for an example of how to use <a href="/openhsi/shared.html#SharedOpenHSI"><code>SharedOpenHSI</code></a> for you custom cameras.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Shared-FLIR-Camera">Shared FLIR Camera<a class="anchor-link" href="#Shared-FLIR-Camera"> </a></h3><p>This should work just like <code>openhsi.cameras.FlirCamera</code>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="SharedFlirCamera" class="doc_header"><code>class</code> <code>SharedFlirCamera</code><a href="https://github.com/openhsi/openhsi/tree/master/openhsi/shared.py#L209" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>SharedFlirCamera</code>(<strong><code>n_lines</code></strong>:<code>int</code>=<em><code>16</code></em>, <strong><code>processing_lvl</code></strong>:<code>int</code>=<em><code>-1</code></em>, <strong><code>json_path</code></strong>:<code>str</code>=<em><code>None</code></em>, <strong><code>pkl_path</code></strong>:<code>str</code>=<em><code>None</code></em>, <strong><code>print_settings</code></strong>=<em><code>False</code></em>) :: <a href="/openhsi/shared.html#SharedOpenHSI"><code>SharedOpenHSI</code></a></p>
</blockquote>

<pre><code>Interface for FLIR camera</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

</div>
 

