---

title: Generating Calibration Files for the OpenHSI Camera


keywords: fastai
sidebar: home_sidebar

summary: "A notebook example for generating settings and calibration files for the OpenHSI camera."
description: "A notebook example for generating settings and calibration files for the OpenHSI camera."
nb_path: "nbs/10_tutorial_calibrate.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/10_tutorial_calibrate.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>{% include warning.html content='This is not for genral use. Requires technical expertise.' %}
Tools required:</p>
<ul>
<li>An integrating sphere (we use a Spectra PT from LabSphere)</li>
<li>A HgAr lamp</li>
</ul>
<p>Adjust the camera class as needed. This example uses the <a href="/openhsi/cameras.html#LucidCamera"><code>LucidCamera</code></a>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">holoviews</span> <span class="k">as</span> <span class="nn">hv</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">openhsi.calibrate</span> <span class="kn">import</span> <span class="n">SettingsBuilderMixin</span><span class="p">,</span> <span class="n">SpectraPTController</span><span class="p">,</span> <span class="n">sum_gaussians</span>
<span class="kn">from</span> <span class="nn">openhsi.cameras</span> <span class="kn">import</span> <span class="n">LucidCamera</span>

<span class="n">hv</span><span class="o">.</span><span class="n">extension</span><span class="p">(</span><span class="s2">&quot;bokeh&quot;</span><span class="p">,</span> <span class="n">logo</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">panel</span> <span class="k">as</span> <span class="nn">pn</span>


<span class="k">class</span> <span class="nc">CalibrateCamera</span><span class="p">(</span><span class="n">SettingsBuilderMixin</span><span class="p">,</span> <span class="n">LucidCamera</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">json_path_template</span> <span class="o">=</span> <span class="s2">&quot;../cals/cam_settings_lucid_template.json&quot;</span>
<span class="n">pkl_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

<span class="n">modelno</span> <span class="o">=</span> <span class="mi">18</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">modelno</span><span class="p">))</span>

<span class="n">json_path_target</span> <span class="o">=</span> <span class="s2">&quot;../cals/OpenHSI-</span><span class="si">{0:02d}</span><span class="s2">/OpenHSI-</span><span class="si">{0:02d}</span><span class="s2">_settings_Mono8_bin1.json&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">modelno</span>
<span class="p">)</span>
<span class="n">pkl_path_target</span> <span class="o">=</span> <span class="s2">&quot;../cals/OpenHSI-</span><span class="si">{0:02d}</span><span class="s2">/OpenHSI-</span><span class="si">{0:02d}</span><span class="s2">_calibration_Mono8_bin1.pkl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">modelno</span>
<span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">json_path_target</span><span class="p">)):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">json_path_target</span><span class="p">))</span>

<span class="n">spt</span> <span class="o">=</span> <span class="n">SpectraPTController</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Find-illuminated-sensor-area">Find illuminated sensor area<a class="anchor-link" href="#Find-illuminated-sensor-area"> </a></h2><p>The vertical directon/y axis of the detector array corrspeonds the across-track direction of the sensor. If the image of slit is shorter then the heigh we can crop the top and bottom to save bandwidth/disk space (similar to letterboxing video).</p>
<p>There are two ways to do this, croping after the fact using row_minmax or by setting up a window on the sensor. Setting up a window will reduce the ammount of data transfered from the sensor and can improve maximum framerate depending on the sensor so is recomended.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="1.-Take-a-flat-field">1. Take a flat field<a class="anchor-link" href="#1.-Take-a-flat-field"> </a></h3><p>First step is to provide a uniform illumination to the slit, ideally spectrally broadband, like a halogen lamp or the sun.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">spt</span><span class="o">.</span><span class="n">selectPreset</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>

<span class="k">with</span> <span class="n">CalibrateCamera</span><span class="p">(</span>
    <span class="n">json_path</span><span class="o">=</span><span class="n">json_path_template</span><span class="p">,</span> <span class="n">pkl_path</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">processing_lvl</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">exposure_ms</span><span class="o">=</span><span class="mi">20</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">cam</span><span class="p">:</span>

    <span class="n">hvim_flat</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">retake_flat_field</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">hvim_flat</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">axiswise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">hvim_row_minmax</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">update_row_minmax</span><span class="p">(</span><span class="n">edgezone</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">hvim_row_minmax</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">axiswise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Use Row min max to update window</span>
    <span class="n">windowheight</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">cam</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;row_slice&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cam</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;row_slice&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Windowheight </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">windowheight</span><span class="p">))</span>

    <span class="n">cam</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;win_resolution&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">windowheight</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">cam</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;resolution&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">cam</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;win_offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">cam</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;row_slice&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">cam</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;win_offset&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">]</span>

    <span class="n">cam</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;row_slice&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="n">windowheight</span> <span class="o">-</span> <span class="mi">8</span><span class="p">]</span>

    <span class="n">cam</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;resolution&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;win_resolution&quot;</span><span class="p">]</span>
    <span class="n">cam</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">json_path</span><span class="o">=</span><span class="n">json_path_target</span><span class="p">,</span> <span class="n">pkl_path</span><span class="o">=</span><span class="n">pkl_path_target</span><span class="p">)</span>
<span class="c1">#     img=cam.crop(cam.calibration[&quot;flat_field_pic&quot;])</span>
<span class="c1">#     hv_flatcrop=hv.Image(img, bounds=(0,0,*img.shape)).opts(xlabel=&quot;wavelength index&quot;,ylabel=&quot;cross-track&quot;,cmap=&quot;gray&quot;,title=&quot;test frame&quot;,width=400,height=400,axiswise=True)</span>

<span class="c1"># spt.selectPreset(1000)</span>
<span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">hvim_row_minmax</span><span class="p">,</span> <span class="n">hvim_flat</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">CalibrateCamera</span><span class="p">(</span>
    <span class="n">n_lines</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">processing_lvl</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">pkl_path</span><span class="o">=</span><span class="n">pkl_path_target</span><span class="p">,</span>
    <span class="n">json_path</span><span class="o">=</span><span class="n">json_path_target</span><span class="p">,</span>
    <span class="n">exposure_ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">cam</span><span class="p">:</span>
    <span class="c1"># cam.collect()</span>
    <span class="n">cam</span><span class="o">.</span><span class="n">start_cam</span><span class="p">()</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">get_img</span><span class="p">()</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">cam</span><span class="o">.</span><span class="n">stop_cam</span><span class="p">()</span>
    <span class="c1"># cam.show(hist_eq=True)</span>

<span class="n">hv</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;wavelength index&quot;</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;cross-track&quot;</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;test frame&quot;</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="2.-Take-Arc-and-setup-wavelength-scale,-and-get-window-for-430-to-900nm">2. Take Arc and setup wavelength scale, and get window for 430 to 900nm<a class="anchor-link" href="#2.-Take-Arc-and-setup-wavelength-scale,-and-get-window-for-430-to-900nm"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">CalibrateCamera</span><span class="p">(</span>
    <span class="n">json_path</span><span class="o">=</span><span class="n">json_path_target</span><span class="p">,</span> <span class="n">pkl_path</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">processing_lvl</span><span class="o">=-</span><span class="mi">1</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">cam</span><span class="p">:</span>
    <span class="n">cam</span><span class="o">.</span><span class="n">deviceSettings</span><span class="p">[</span><span class="s2">&quot;Gain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">10.0</span>
    <span class="n">hvimg</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">retake_HgAr</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nframes</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
    <span class="c1"># hvimg=hv.Image(cam.crop(cam.calibration[&quot;HgAr_pic&quot;]), bounds=(0,0,*cam.calibration[&quot;HgAr_pic&quot;].shape)).opts(</span>
    <span class="c1">#                 xlabel=&quot;wavelength index&quot;,ylabel=&quot;cross-track&quot;,cmap=&quot;gray&quot;,title=&quot;HgAr spectra picture&quot;)</span>

    <span class="n">hvimg</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">cam</span><span class="o">.</span><span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;HgAr_pic&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">smile_fit_hv</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">update_smile_shifts</span><span class="p">()</span>

    <span class="c1"># cam.deviceSettings[&#39;Gain&#39;].value=15.</span>
    <span class="c1"># hvimg=cam.retake_HgAr(show=True,nframes=18)</span>

    <span class="n">cam</span><span class="o">.</span><span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;smile_shifts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;smile_shifts&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">0</span>

    <span class="n">wavefit_hv</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">fit_HgAr_lines</span><span class="p">(</span>
        <span class="n">top_k</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
        <span class="n">brightest_peaks</span><span class="o">=</span><span class="p">[</span><span class="mf">546.96</span><span class="p">,</span> <span class="mf">435.833</span><span class="p">,</span> <span class="p">(</span><span class="mf">579.960</span> <span class="o">+</span> <span class="mf">579.066</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">763.511</span><span class="p">],</span>
        <span class="n">find_peaks_height</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">prominence</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">width</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
        <span class="n">interactive_peak_id</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># [435.833,546.074,,763.511]</span>

    <span class="c1"># Use wavecal to narrow spetral range.</span>
    <span class="n">waveminmax</span> <span class="o">=</span> <span class="p">[</span><span class="mi">430</span><span class="p">,</span> <span class="mi">900</span><span class="p">]</span>
    <span class="n">waveminmax_ind</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cam</span><span class="o">.</span><span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;wavelengths_linear&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">λ</span><span class="p">))</span> <span class="k">for</span> <span class="n">λ</span> <span class="ow">in</span> <span class="n">waveminmax</span>
    <span class="p">]</span>

    <span class="n">window_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">waveminmax_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">waveminmax_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">offset_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">waveminmax_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Window Width </span><span class="si">{}</span><span class="s2">, offset x </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">window_width</span><span class="p">,</span> <span class="n">offset_x</span><span class="p">))</span>

    <span class="n">cam</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;win_resolution&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">window_width</span>
    <span class="n">cam</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;win_offset&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset_x</span>
    <span class="n">cam</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;resolution&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;win_resolution&quot;</span><span class="p">]</span>

    <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="n">hvimg</span><span class="p">,</span>
        <span class="n">smile_fit_hv</span><span class="p">,</span>
        <span class="n">wavefit_hv</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mi">390</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">shared_axes</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
    <span class="n">hvimg</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">shared_axes</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">smile_fit_hv</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">shared_axes</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">wavefit_hv</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="mi">900</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">shared_axes</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cam</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">json_path</span><span class="o">=</span><span class="n">json_path_target</span><span class="p">,</span> <span class="n">pkl_path</span><span class="o">=</span><span class="n">pkl_path_target</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="3.-Retake-flat-field-and-arc-with-windows">3. Retake flat field and arc with windows<a class="anchor-link" href="#3.-Retake-flat-field-and-arc-with-windows"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">spt</span><span class="o">.</span><span class="n">selectPreset</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>

<span class="k">with</span> <span class="n">CalibrateCamera</span><span class="p">(</span>
    <span class="n">json_path</span><span class="o">=</span><span class="n">json_path_target</span><span class="p">,</span> <span class="n">pkl_path</span><span class="o">=</span><span class="n">pkl_path_target</span><span class="p">,</span> <span class="n">processing_lvl</span><span class="o">=-</span><span class="mi">1</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">cam</span><span class="p">:</span>
    <span class="n">hvim_flat</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">retake_flat_field</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">hvim_flat</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">axiswise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">hvim_row_minmax</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">update_row_minmax</span><span class="p">(</span><span class="n">edgezone</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">hvim_row_minmax</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">axiswise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">cam</span><span class="o">.</span><span class="n">update_resolution</span><span class="p">()</span>
    <span class="n">cam</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">json_path</span><span class="o">=</span><span class="n">json_path_target</span><span class="p">,</span> <span class="n">pkl_path</span><span class="o">=</span><span class="n">pkl_path_target</span><span class="p">)</span>

<span class="c1"># spt.turnOffLamp()</span>

<span class="n">hvim_row_minmax</span> <span class="o">+</span> <span class="n">hvim_flat</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Redo-Arc-with-window.">Redo Arc with window.<a class="anchor-link" href="#Redo-Arc-with-window."> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">CalibrateCamera</span><span class="p">(</span>
    <span class="n">json_path</span><span class="o">=</span><span class="n">json_path_target</span><span class="p">,</span> <span class="n">pkl_path</span><span class="o">=</span><span class="n">pkl_path_target</span><span class="p">,</span> <span class="n">processing_lvl</span><span class="o">=-</span><span class="mi">1</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">cam</span><span class="p">:</span>
    <span class="n">cam</span><span class="o">.</span><span class="n">deviceSettings</span><span class="p">[</span><span class="s2">&quot;Gain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">15.0</span>
    <span class="n">hvimg</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">retake_HgAr</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">hvimg</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">cam</span><span class="o">.</span><span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;HgAr_pic&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">smile_fit_hv</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">update_smile_shifts</span><span class="p">()</span>

    <span class="n">wavefit_hv</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">fit_HgAr_lines</span><span class="p">(</span>
        <span class="n">top_k</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
        <span class="n">brightest_peaks</span><span class="o">=</span><span class="p">[</span><span class="mf">546.96</span><span class="p">,</span> <span class="mf">435.833</span><span class="p">,</span> <span class="p">(</span><span class="mf">579.960</span> <span class="o">+</span> <span class="mf">579.066</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">871.66</span><span class="p">,</span> <span class="mf">763.511</span><span class="p">],</span>
        <span class="n">find_peaks_height</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">prominence</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">width</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
        <span class="n">max_match_error</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">interactive_peak_id</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># [435.833,546.074,(579.960+579.066)/2,763.511]</span>
    
    <span class="n">cam</span><span class="o">.</span><span class="n">update_intsphere_fit</span><span class="p">()</span>

    <span class="n">cam</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">json_path</span><span class="o">=</span><span class="n">json_path_target</span><span class="p">,</span> <span class="n">pkl_path</span><span class="o">=</span><span class="n">pkl_path_target</span><span class="p">)</span>

<span class="p">(</span><span class="n">hvimg</span> <span class="o">+</span> <span class="n">smile_fit_hv</span> <span class="o">+</span> <span class="n">wavefit_hv</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="mi">900</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">255</span><span class="p">)))</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">shared_axes</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="3.-Get-Integrating-Sphere-data-for-radiance-calibration">3. Get Integrating Sphere data for radiance calibration<a class="anchor-link" href="#3.-Get-Integrating-Sphere-data-for-radiance-calibration"> </a></h3><p>4D datacube with coordinates of cross-track, wavelength, exposure, and luminance.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">lum_preset_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1000</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="mi">2000</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="mi">3000</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="mi">4000</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="mi">5000</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
    <span class="mi">6000</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
    <span class="mi">7000</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
    <span class="mi">8000</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
    <span class="mi">9000</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="mi">10000</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
    <span class="mi">20000</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
    <span class="mi">25000</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span>
    <span class="mi">30000</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
    <span class="mi">35000</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
    <span class="mi">40000</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">lum_preset_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="mi">1000</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="mi">2000</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="mi">4000</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="mi">6000</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
    <span class="mi">8000</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
    <span class="mi">10000</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
    <span class="mi">20000</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
    <span class="mi">40000</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">luminances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">lum_preset_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="c1"># luminances = np.append(luminances,0)</span>
<span class="n">exposures</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>

<span class="k">with</span> <span class="n">CalibrateCamera</span><span class="p">(</span>
    <span class="n">json_path</span><span class="o">=</span><span class="n">json_path_target</span><span class="p">,</span> <span class="n">pkl_path</span><span class="o">=</span><span class="n">pkl_path_target</span><span class="p">,</span> <span class="n">processing_lvl</span><span class="o">=-</span><span class="mi">1</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">cam</span><span class="p">:</span>

    <span class="n">cam</span><span class="o">.</span><span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;rad_ref&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">update_intsphere_cube</span><span class="p">(</span>
        <span class="n">exposures</span><span class="p">,</span> <span class="n">luminances</span><span class="p">,</span> <span class="n">noframe</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">lum_chg_func</span><span class="o">=</span><span class="n">spt</span><span class="o">.</span><span class="n">selectPreset</span>
    <span class="p">)</span>

    <span class="c1"># remove saturated images</span>
    <span class="n">cam</span><span class="o">.</span><span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;rad_ref&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;rad_ref&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="o">~</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">cam</span><span class="o">.</span><span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;rad_ref&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mi">255</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="o">&gt;</span> <span class="mi">1000</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">cam</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">json_path</span><span class="o">=</span><span class="n">json_path_target</span><span class="p">,</span> <span class="n">pkl_path</span><span class="o">=</span><span class="n">pkl_path_target</span><span class="p">)</span>

<span class="n">spt</span><span class="o">.</span><span class="n">turnOffLamp</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cam</span><span class="o">.</span><span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;rad_ref&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;cross_track&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;wavelength_index&quot;</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;exposure&quot;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="s2">&quot;luminance&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;rad_ref is </span><span class="si">{}</span><span class="s2"> MB&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cam</span><span class="o">.</span><span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;rad_ref&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cam</span><span class="o">.</span><span class="n">update_intsphere_fit</span><span class="p">()</span>
<span class="n">cam</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">json_path</span><span class="o">=</span><span class="n">json_path_target</span><span class="p">,</span> <span class="n">pkl_path</span><span class="o">=</span><span class="n">pkl_path_target</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

